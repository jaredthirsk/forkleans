@page "/game"
@using Shooter.Client.Services
@using Shooter.Client.Components
@using Shooter.Shared.Models
@inject GameClientService HttpGameClient
@inject UdpGameClientService UdpGameClient
@inject IGameClientProvider ClientProvider
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Space Shooter</PageTitle>

<div class="game-container">
    @if (!_isConnected)
    {
        <div class="connection-form">
            <h2>Enter Game</h2>
            <input @bind="_playerName" placeholder="Enter your name" />
            <button @onclick="ConnectToGame" disabled="@_isConnecting">
                @if (_isConnecting)
                {
                    <span>Connecting...</span>
                }
                else
                {
                    <span>Connect</span>
                }
            </button>
            
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="error">@_errorMessage</div>
            }
            
            <div class="connection-type">
                <small>Using: @(ClientProvider.UseRpc ? "UDP" : "HTTP") connection</small>
            </div>
        </div>
    }
    else
    {
        <div class="game-layout">
            <div class="game-main">
                <GameCanvas Width="1200" Height="800" 
                           WorldState="@_currentWorldState" 
                           PlayerId="@_playerId"
                           ServerId="@_currentServerId"
                           AvailableZones="@_availableZones" />
            </div>
            <div class="game-sidebar">
                <GameControls IsConnected="_isConnected"
                             OnMove="HandleMove"
                             OnShoot="HandleShoot" />
                             
                <div class="game-stats">
                    <h4>Stats</h4>
                    <p>FPS: @_fps</p>
                    <p>Entities: @(_currentWorldState?.Entities?.Count ?? 0)</p>
                    <p>Connection: @(ClientProvider.UseRpc ? "UDP" : "HTTP")</p>
                    <p>Server: @_currentServerId</p>
                </div>
                
                <button class="disconnect-btn" @onclick="Disconnect">Disconnect</button>
                
                <!-- Manual navbar toggle -->
                <button class="navbar-toggle-btn" @onclick="ToggleNavbar">
                    Toggle Navbar
                </button>
            </div>
        </div>
    }
</div>

<style>
    .game-container {
        padding: 20px;
        min-height: calc(100vh - 56px);
        background-color: #1a1a1a;
    }
    
    .connection-form {
        max-width: 400px;
        margin: 100px auto;
        padding: 30px;
        background-color: #2a2a2a;
        border-radius: 8px;
        text-align: center;
    }
    
    .connection-form h2 {
        color: #888;
        margin-bottom: 20px;
    }
    
    .connection-form input {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #333;
        border: 1px solid #444;
        color: white;
        border-radius: 4px;
    }
    
    .connection-form button {
        width: 100%;
        padding: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .connection-form button:disabled {
        background-color: #666;
        cursor: not-allowed;
    }
    
    .error {
        color: #ff4444;
        margin-top: 10px;
    }
    
    .connection-type {
        margin-top: 10px;
        color: #888;
    }
    
    .game-layout {
        display: flex;
        gap: 20px;
    }
    
    .game-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .game-stats {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        color: white;
    }
    
    .game-stats h4 {
        margin-top: 0;
        color: #888;
    }
    
    .disconnect-btn {
        padding: 10px 20px;
        background-color: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .navbar-toggle-btn {
        padding: 10px 20px;
        background-color: #555;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
</style>

@code {
    private string _playerName = "";
    private string _playerId = "";
    private string _currentServerId = "";
    private bool _isConnected = false;
    private bool _isConnecting = false;
    private string _errorMessage = "";
    private WorldState? _currentWorldState;
    private int _fps = 0;
    private DateTime _lastFpsUpdate = DateTime.UtcNow;
    private int _frameCount = 0;
    private Vector2 _currentMoveDirection = Vector2.Zero;
    private bool _currentIsShooting = false;
    private List<GridSquare> _availableZones = new();
    
    protected override void OnInitialized()
    {
        if (ClientProvider.UseRpc)
        {
            UdpGameClient.WorldStateUpdated += OnWorldStateUpdated;
            UdpGameClient.AvailableZonesUpdated += OnAvailableZonesUpdated;
            UdpGameClient.ServerChanged += OnServerChanged;
        }
        else
        {
            HttpGameClient.WorldStateUpdated += OnWorldStateUpdated;
            HttpGameClient.AvailableZonesUpdated += OnAvailableZonesUpdated;
            HttpGameClient.ServerChanged += OnServerChanged;
        }
    }
    
    private async Task ConnectToGame()
    {
        if (string.IsNullOrWhiteSpace(_playerName))
        {
            _errorMessage = "Please enter your name";
            return;
        }
        
        _isConnecting = true;
        _errorMessage = "";
        
        try
        {
            bool connected;
            if (ClientProvider.UseRpc)
            {
                connected = await UdpGameClient.ConnectAsync(_playerName);
                if (connected)
                {
                    _playerId = UdpGameClient.PlayerId ?? string.Empty;
                    _currentServerId = UdpGameClient.CurrentServerId ?? "Unknown";
                }
            }
            else
            {
                connected = await HttpGameClient.ConnectAsync(_playerName);
                if (connected)
                {
                    _playerId = HttpGameClient.PlayerId ?? string.Empty;
                    _currentServerId = HttpGameClient.CurrentServerId ?? "Unknown";
                }
            }
            
            if (connected)
            {
                _isConnected = true;
            }
            else
            {
                _errorMessage = "Failed to connect to game server";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Connection error: {ex.Message}";
        }
        finally
        {
            _isConnecting = false;
        }
    }
    
    private async Task Disconnect()
    {
        if (ClientProvider.UseRpc)
        {
            await UdpGameClient.DisconnectAsync();
        }
        else
        {
            await HttpGameClient.DisconnectAsync();
        }
        
        _isConnected = false;
        Navigation.NavigateTo("/");
    }
    
    private async Task HandleMove(Vector2 direction)
    {
        _currentMoveDirection = direction;
        if (_isConnected)
        {
            if (ClientProvider.UseRpc)
            {
                await UdpGameClient.SendPlayerInput(_currentMoveDirection, _currentIsShooting);
            }
            else
            {
                await HttpGameClient.SendPlayerInput(_currentMoveDirection, _currentIsShooting);
            }
        }
    }
    
    private async Task HandleShoot(bool isShooting)
    {
        _currentIsShooting = isShooting;
        if (_isConnected)
        {
            if (ClientProvider.UseRpc)
            {
                await UdpGameClient.SendPlayerInput(_currentMoveDirection, _currentIsShooting);
            }
            else
            {
                await HttpGameClient.SendPlayerInput(_currentMoveDirection, _currentIsShooting);
            }
        }
    }
    
    private void OnWorldStateUpdated(WorldState worldState)
    {
        _currentWorldState = worldState;
        
        // Update FPS counter
        _frameCount++;
        var now = DateTime.UtcNow;
        if ((now - _lastFpsUpdate).TotalSeconds >= 1)
        {
            _fps = _frameCount;
            _frameCount = 0;
            _lastFpsUpdate = now;
        }
        
        InvokeAsync(StateHasChanged);
    }
    
    private void OnAvailableZonesUpdated(List<GridSquare> availableZones)
    {
        _availableZones = availableZones;
        InvokeAsync(StateHasChanged);
    }
    
    private void OnServerChanged(string serverId)
    {
        _currentServerId = serverId;
        InvokeAsync(StateHasChanged);
    }
    
    private void ToggleNavbar()
    {
        // Toggle navbar visibility - simple implementation
        // In a real app, you'd want to use JavaScript interop to toggle Bootstrap navbar
        Navigation.NavigateTo(Navigation.Uri + "#toggle", forceLoad: false);
    }
    
    public void Dispose()
    {
        if (ClientProvider.UseRpc)
        {
            UdpGameClient.WorldStateUpdated -= OnWorldStateUpdated;
            UdpGameClient.AvailableZonesUpdated -= OnAvailableZonesUpdated;
            UdpGameClient.ServerChanged -= OnServerChanged;
        }
        else
        {
            HttpGameClient.WorldStateUpdated -= OnWorldStateUpdated;
            HttpGameClient.AvailableZonesUpdated -= OnAvailableZonesUpdated;
            HttpGameClient.ServerChanged -= OnServerChanged;
        }
    }
}